# 出力検証ガイド

## 概要

本ドキュメントはGoで実装されたコレクターの出力を、既存のシェルスクリプト版と比較検証する際の基準を定義します。

## シェルスクリプトとの比較

### 必須チェック項目

| 項目         | 説明                                                                              |
| ------------ | --------------------------------------------------------------------------------- |
| ヘッダー一致 | CSVヘッダーがシェルスクリプトの出力と完全に一致すること                           |
| ヘッダー形式 | **ヘッダー名はすべてCamelCaseで統一すること（例: `RequestDate`, `CreatedDate`）** |
| カラム順序   | カラムの順序がシェルスクリプトと同じであること                                    |
| 行数         | 取得されるリソース数が同じであること（改行を含むフィールドに注意）                |
| 出力順序     | リソースの出力順序がシェルスクリプトと同じであること                              |
| フィールド値 | 各フィールドの値がシェルスクリプトの出力と一致すること                            |
| 特殊文字     | 改行、カンマ、ダブルクォートを含むフィールドが正しくエスケープされていること      |

### 出力順序ルール

シェルスクリプトの出力順序を完全に再現すること:

| カテゴリ | 順序ルール                                                     |
| -------- | -------------------------------------------------------------- |
| RDS      | DBCluster → 関連するDBInstance（Writer → Reader順） の順で出力 |
| ECS      | Cluster → Service → Task の順で出力                            |
| その他   | シェルスクリプトの`jq`ソートに従う                             |

### フィールド形式

| フィールドタイプ | 形式                                                       |
| ---------------- | ---------------------------------------------------------- |
| 日付             | RFC3339形式（例: `2024-01-01T00:00:00Z`）                  |
| Boolean          | `true`/`false`（小文字）                                   |
| 空値             | 空文字列 `""` または `N/A`（シェルスクリプトに合わせる）   |
| リスト           | 改行区切りまたはカンマ区切り（シェルスクリプトに合わせる） |
| JSON             | シェルスクリプトがJSONを出力する場合は同様にJSON形式で出力 |

### グローバルサービス対応

以下のサービスはグローバルサービスのため、`us-east-1`のみで収集すること:

- S3
- IAM
- CloudFront
- Route53
- WAF

```go
if region != "us-east-1" {
    return nil, nil
}
```

## テスト手順

### 単体テスト

```bash
# ビルド確認
go build ./cmd/arc

# lint確認
golangci-lint run ./internal/aws/resources/...
```

### 比較テスト

**比較基準ファイル**: `/workspace/tmp/check/250434603753/resources/*.csv`

```bash
# Go版実行
./arc -c <category> -r <region>

# 比較（checkディレクトリを基準とする）
diff /workspace/output/250434603753/resources/<category>.csv /workspace/tmp/check/250434603753/resources/<category>.csv

# または詳細比較
diff -u /workspace/tmp/check/250434603753/resources/<category>.csv /workspace/output/250434603753/resources/<category>.csv | head -50
```

**重要**: `/workspace/tmp/check/`ディレクトリのファイルがマスター（正解）データです。Go実装の出力がこれと一致することを確認してください。

**注記**: CSVのクォート処理（`"N/A"` vs `N/A`）に関する微細な差異は、CSVとして有効である限り許容されます。

### 比較時の注意点

- **日付形式**: Go版はUTC（`Z`サフィックス）、シェル版はタイムゾーン付き（`+00:00`）の場合がある
- **AZ順序**: AWS APIが返す順序に依存するため、多少の差異は許容可能
- **空白**: 末尾スペースや改行の違いに注意

## 完了基準

コレクターの実装は以下の条件をすべて満たした場合に完了とする:

1. ✅ `go build` 成功
2. ✅ `golangci-lint` エラーなし
3. ✅ シェルスクリプトとヘッダーが一致
4. ✅ シェルスクリプトとカラム順序が一致
5. ✅ シェルスクリプトと出力順序が一致
6. ✅ シェルスクリプトとフィールド値が一致（許容される差異を除く）
