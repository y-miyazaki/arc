# Reusable workflow for Terraform CD operations
# This workflow can be called by other workflows to perform Terraform CD operations
name: reusable-cd-terraform-aws

on:
  workflow_call:
    inputs:
      component:
        description: "Terraform component (base, monitor, management)"
        required: true
        type: string
      environment:
        description: "Target environment (dev, qa, stg, prd, audit, root)"
        required: true
        type: string
      plan:
        description: "Execute terraform plan"
        required: false
        type: boolean
        default: false
      terraform_path:
        description: "Path to terraform configuration"
        required: true
        type: string
      terraform_version:
        description: "Terraform version to use"
        required: false
        type: string
        default: "1.12.2"
    secrets:
      AWS_IAM_ROLE_ARN:
        required: true
      AWS_REGION:
        required: true

env:
  COMPONENT: ${{ inputs.component }}
  ENVIRONMENT: ${{ inputs.environment }}
  TERRAFORM_PATH: ${{ inputs.terraform_path }}
  TERRAFORM_VERSION: ${{ inputs.terraform_version }}

jobs:
  init:
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    environment:
      name: ${{ inputs.environment }}
    outputs:
      tf_init_cache_key: ${{ steps.compute-init-cache-key.outputs.key }}
      tf_plugin_cache_key: ${{ steps.compute-plugin-cache-key.outputs.key }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Setup AWS Credentials
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Terraform plugin cache
        run: |
          # shellcheck disable=SC2016
          echo 'plugin_cache_dir="$HOME/.terraform.d/plugin-cache"' >~/.terraformrc
          mkdir --parents ~/.terraform.d/plugin-cache

      - name: Setup Terraform plugin cache key
        id: compute-plugin-cache-key
        run: |
          # shellcheck disable=SC2016,SC2086
          echo "key=terraform-plugin-cache-${ENVIRONMENT}-${COMPONENT}-${{ runner.os }}-${{ hashFiles(format('{0}/.terraform.lock.hcl', env.TERRAFORM_PATH)) }}" >> "$GITHUB_OUTPUT"

      - name: Setup Terraform init cache key
        id: compute-init-cache-key
        run: |
          # shellcheck disable=SC2016,SC2086
          echo "key=terraform-init-${ENVIRONMENT}-${COMPONENT}-${{ runner.os }}-${{ hashFiles(format('{0}/terraform.{1}.tfbackend', env.TERRAFORM_PATH, env.ENVIRONMENT), format('{0}/.terraform.lock.hcl', env.TERRAFORM_PATH), format('{0}/**/*.tf', env.TERRAFORM_PATH), 'modules/**/*.tf') }}" >> "$GITHUB_OUTPUT"

      - name: Restore Cache Terraform plugin cache
        id: restore-terraform-plugin-cache
        uses: actions/cache/restore@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            ~/.terraform.d/plugin-cache
          key: ${{ steps.compute-plugin-cache-key.outputs.key }}

      - name: Restore Cache Terraform init
        id: restore-terraform-init
        uses: actions/cache/restore@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            ${{ env.TERRAFORM_PATH }}/.terraform
            ${{ env.TERRAFORM_PATH }}/.terraform.lock.hcl
          key: ${{ steps.compute-init-cache-key.outputs.key }}

      - name: Exec Terraform init
        id: init
        run: |
          # shellcheck disable=SC2016
          if [ ! -d "${TERRAFORM_PATH}/.terraform" ]; then
            echo "Cache miss or incomplete modules - initializing Terraform for ${COMPONENT}"
            terraform -chdir="${TERRAFORM_PATH}" init -reconfigure -backend-config=terraform."${ENVIRONMENT}".tfbackend
          else
            echo "Cache hit - skipping Terraform init for ${COMPONENT}"
          fi

      - name: Save Cache Terraform plugin cache
        if: ${{ steps.restore-terraform-plugin-cache.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            ~/.terraform.d/plugin-cache
          key: ${{ steps.compute-plugin-cache-key.outputs.key }}

      - name: Save Cache Terraform init
        if: ${{ steps.restore-terraform-init.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            ${{ env.TERRAFORM_PATH }}/.terraform
            ${{ env.TERRAFORM_PATH }}/.terraform.lock.hcl
          key: ${{ steps.compute-init-cache-key.outputs.key }}

  deploy:
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    needs: init
    environment:
      name: ${{ inputs.environment }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Setup AWS Credentials
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup Terraform plugin cache
        run: |
          # shellcheck disable=SC2016
          echo 'plugin_cache_dir="$HOME/.terraform.d/plugin-cache"' >~/.terraformrc
          mkdir --parents ~/.terraform.d/plugin-cache

      - name: Restore Cache Terraform plugin cache
        id: restore-terraform-plugin-cache
        uses: actions/cache/restore@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            ~/.terraform.d/plugin-cache
          key: ${{ needs.init.outputs.tf_plugin_cache_key }}

      - name: Restore Cache Terraform init
        id: restore-terraform-init
        uses: actions/cache/restore@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            ${{ env.TERRAFORM_PATH }}/.terraform
            ${{ env.TERRAFORM_PATH }}/.terraform.lock.hcl
          key: ${{ needs.init.outputs.tf_init_cache_key }}

      - name: Exec Terraform init
        id: init
        run: |
          if [ ! -d "${TERRAFORM_PATH}/.terraform" ]; then
            echo "Cache miss or incomplete modules - initializing Terraform for ${COMPONENT}"
            terraform -chdir="${TERRAFORM_PATH}" init -reconfigure -backend-config=terraform."${ENVIRONMENT}".tfbackend
          else
            echo "Cache hit - skipping Terraform init for ${COMPONENT}"
          fi

      - name: Exec Terraform plan
        if: ${{ inputs.plan == true }}
        id: plan
        shell: bash
        run: |
          terraform -chdir="${TERRAFORM_PATH}" plan -lock=false -var-file=terraform."${ENVIRONMENT}".tfvars

      - name: Exec Terraform apply
        id: apply
        shell: bash
        run: |
          terraform -chdir="${TERRAFORM_PATH}" apply --auto-approve -var-file=terraform."${ENVIRONMENT}".tfvars

      - name: Summary
        if: always()
        uses: ./.github/actions/summary
        with:
          artifacts: |
            (none)
          outputs: |
            (none)
          params: |
            component: ${{ inputs.component }}
            environment: ${{ inputs.environment }}
            plan: ${{ inputs.plan }}
            terraform_path: ${{ inputs.terraform_path }}
          status: "${{ job.status }}"
          title: "${{ format('Terraform CD: {0}', env.COMPONENT) }}"
