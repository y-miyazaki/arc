# Reusable workflow for Go application release using GoReleaser
# This workflow builds cross-platform binaries and creates GitHub releases with GoReleaser.
# It can be called from other workflows to perform CD operations for Go applications.
name: reusable-cd-go-release

on:
  workflow_call:
    inputs:
      component:
        description: "Logical component name (e.g. arc)"
        required: true
        type: string
      create_tag:
        description: "Create a git tag if it doesn't exist (true/false)"
        required: false
        type: boolean
        default: true
      draft:
        description: "Create a draft release (true/false)"
        required: false
        type: boolean
        default: false
      go_path:
        description: "Path (relative) to the Go project root (directory containing go.mod)"
        required: false
        type: string
        default: "."
      go_version:
        description: "Go version to use for building"
        required: false
        type: string
        default: "1.25.4"
      goreleaser_args:
        description: "Additional GoReleaser arguments (e.g. --skip=validate)"
        required: false
        type: string
        default: ""
      goreleaser_version:
        description: "GoReleaser version to use"
        required: false
        type: string
        default: "v2.6.1"
      prerelease:
        description: "Mark as prerelease (true/false, or 'auto' for automatic detection)"
        required: false
        type: string
        default: "auto"
      version:
        description: "Release version (e.g. v1.0.0). Must start with 'v'. If empty, uses the tag that triggered the workflow."
        required: false
        type: string

env:
  COMPONENT: ${{ inputs.component }}
  CREATE_TAG: ${{ inputs.create_tag }}
  DRAFT: ${{ inputs.draft }}
  GO_PROJECT_PATH: ${{ inputs.go_path }}
  GO_VERSION: ${{ inputs.go_version }}
  GORELEASER_ARGS: ${{ inputs.goreleaser_args }}
  GORELEASER_VERSION: ${{ inputs.goreleaser_version }}
  PRERELEASE: ${{ inputs.prerelease }}
  VERSION: ${{ inputs.version }}

jobs:
  release:
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    concurrency:
      group: go-release-${{ inputs.component }}-${{ inputs.version }}
      cancel-in-progress: false
    permissions:
      contents: write # Required for creating releases and tags
      id-token: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8cf # v5.0.0
        with:
          fetch-depth: 0 # Required for GoReleaser to generate changelog
          persist-credentials: true

      - name: Validate version format
        if: inputs.version != ''
        run: |
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "‚ùå Error: Version must start with 'v' and follow semantic versioning (e.g. v1.0.0, v1.0.0-beta.1)"
            exit 1
          fi
          echo "‚úÖ Version format is valid: $VERSION"

      - name: Check if tag exists
        id: check-tag
        run: |
          if [ -z "$VERSION" ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            if [[ "$VERSION" == "refs/"* ]]; then
              echo "‚ùå Error: No version provided and workflow not triggered by a tag"
              exit 1
            fi
          fi

          git fetch --tags
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "tag_exists=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Tag $VERSION already exists"
          else
            echo "tag_exists=false" >> "$GITHUB_OUTPUT"
            echo "‚ö†Ô∏è  Tag $VERSION does not exist"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Create tag
        if: steps.check-tag.outputs.tag_exists == 'false' && inputs.create_tag == true
        run: |
          VERSION="${{ steps.check-tag.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"
          echo "‚úÖ Created and pushed tag: $VERSION"

      - name: Fetch tags after creation
        if: steps.check-tag.outputs.tag_exists == 'false' && inputs.create_tag == true
        run: |
          git fetch --tags --force
          echo "‚úÖ Tags refreshed"

      - name: Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Determine Go cache paths
        id: go-cache-paths
        working-directory: ${{ env.GO_PROJECT_PATH }}
        run: |
          {
            echo "gomodcache=$(go env GOMODCACHE)"
            echo "gocache=$(go env GOCACHE)"
          } >> "$GITHUB_OUTPUT"

      - name: Setup Go module cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ${{ steps.go-cache-paths.outputs.gomodcache }}
          key: ${{ runner.os }}-gomodcache-${{ hashFiles(format('{0}/go.sum', env.GO_PROJECT_PATH)) }}
          restore-keys: |
            ${{ runner.os }}-gomodcache-

      - name: Setup Go build cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ${{ steps.go-cache-paths.outputs.gocache }}
          key: ${{ runner.os }}-gocache-${{ hashFiles(format('{0}/**/*.go', env.GO_PROJECT_PATH)) }}
          restore-keys: |
            ${{ runner.os }}-gocache-

      - name: Download dependencies
        working-directory: ${{ env.GO_PROJECT_PATH }}
        run: |
          go mod download
          echo "‚úÖ Dependencies downloaded"

      - name: Prepare GoReleaser arguments
        id: goreleaser-args
        run: |
          ARGS="release --clean --parallelism 2"
          # Skip git validation if we just created the tag
          if [ "${{ steps.check-tag.outputs.tag_exists }}" == "false" ] && [ "${{ inputs.create_tag }}" == "true" ]; then
            ARGS="$ARGS --skip=validate"
            echo "‚ö†Ô∏è  Skipping git validation for newly created tag"
          fi
          if [ -n "$GORELEASER_ARGS" ]; then
            ARGS="$ARGS $GORELEASER_ARGS"
          fi
          echo "args=$ARGS" >> "$GITHUB_OUTPUT"
          echo "‚úÖ GoReleaser arguments: $ARGS"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          distribution: goreleaser
          version: ${{ env.GORELEASER_VERSION }}
          args: ${{ steps.goreleaser-args.outputs.args }}
          workdir: ${{ env.GO_PROJECT_PATH }}
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GORELEASER_CURRENT_TAG: ${{ steps.check-tag.outputs.version }}

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: goreleaser-dist-${{ inputs.component }}-${{ steps.check-tag.outputs.version }}
          path: |
            ${{ env.GO_PROJECT_PATH }}/dist/*.tar.gz
            ${{ env.GO_PROJECT_PATH }}/dist/*.zip
            ${{ env.GO_PROJECT_PATH }}/dist/*checksums.txt
          retention-days: 30
          if-no-files-found: warn

      - name: Notify success
        if: success()
        run: |
          VERSION="${{ steps.check-tag.outputs.version }}"
          echo "üéâ Successfully released $COMPONENT $VERSION"
          echo "üì¶ Release URL: https://github.com/${{ github.repository }}/releases/tag/$VERSION"

      - name: Notify failure
        if: failure()
        run: |
          VERSION="${{ steps.check-tag.outputs.version }}"
          echo "‚ùå Failed to release $COMPONENT $VERSION"
          echo "Please check the logs for details"
          exit 1
